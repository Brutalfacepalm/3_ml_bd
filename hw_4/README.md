
### TF-IDF by Spark DataFrame API. ###

##### Run Docker #####
    sudo docker run -p 7077:7077 -p 8080:8080 -p 4040:4040 -v $PWD/data:/data -v $PWD/notebook:/notebook -e ZEPPELIN_NOTEBOOK_DIR="/notebook" --name zeppelin apache/zeppelin:0.10.0
 
Запускаем докер контейнер. Пробрасываем папки с ноутбуками и данными

##### Run Spark #####
    spark
    import org.apache.spark.sql._
    import org.apache.spark.sql.functions._
    import spark.implicits._

##### Load data and clear #####
    val hotels_review = spark.read.format("csv").option("header", "true").load("/data/tripadvisor_hotel_reviews.csv")
        .drop("Rating").select(split(lower(trim(regexp_replace(col("Review"),"\\p{Punct}", "")))," ").as("ReviewSeq"))
        .withColumn("doc_id", monotonically_increasing_id())

<details>
    <summary>Output</summary>
    +--------------------+------+
    |           ReviewSeq|doc_id|
    +--------------------+------+
    |[nice, hotel, exp...|     0|
    |[ok, nothing, spe...|     1|
    |[nice, rooms, not...|     2|
    |[unique, great, s...|     3|
    |[great, stay, gre...|     4|
    |[love, monaco, st...|     5|
    |[cozy, stay, rain...|     6|
    |[excellent, staff...|     7|
    |[hotel, stayed, h...|     8|
    |[excellent, staye...|     9|
    |[poor, value, sta...|    10|
    |[nice, value, sea...|    11|
    |[nice, hotel, goo...|    12|
    |[nice, hotel, not...|    13|
    |[great, hotel, ni...|    14|
    |[horrible, custom...|    15|
    |[disappointed, sa...|    16|
    |[fantastic, stay,...|    17|
    |[good, choice, ho...|    18|
    |[hmmmmm, say, rea...|    19|
    +--------------------+------+
</details>

##### Get TF #####
    val columns = hotels_review.columns.map(col) :+
      (explode(col("ReviewSeq")) as "token")

    val column_tokens = hotels_review.select(columns: _*)

    val tf = column_tokens.groupBy("doc_id", "token")
          .agg(count("ReviewSeq") as "tf")

<details>
    <summary>Output</summary>
    +------+----------+---+
    |doc_id|     token| tf|
    +------+----------+---+
    |     0|      room|  3|
    |     1|    better|  2|
    |     6|attractive|  1|
    |     6|  positive|  1|
    |     7| concierge|  2|
    |    10|        nt|  2|
    |    12|     clean|  1|
    |    12|   concert|  1|
    |    15|      stay|  2|
    |    16|      desk|  6|
    |    19|       bed|  1|
    |    30| excellent|  1|
    |    32|    really|  1|
    |    44| cringeshe|  1|
    |    46|      mind|  1|
    |    51|    pretty|  1|
    |    52|     steer|  1|
    |    54|     tacky|  1|
    |    58|   staying|  1|
    |    63|       etc|  1|
    +------+----------+---+
</details>

##### Get DF #####
Limit 100

    val df = tf.groupBy("token")
      .agg(countDistinct("doc_id") as "df").orderBy(desc("df")).limit(100)

<details>
    <summary>Output</summary>
    +---------+-----+
    |    token|   df|
    +---------+-----+
    |    hotel|16319|
    |     room|14049|
    |      not|12123|
    |    staff|11522|
    |    great|11020|
    |     stay|10094|
    |     good| 9277|
    |   stayed| 8549|
    |       nt| 8379|
    |    rooms| 8336|
    | location| 8164|
    |     just| 7736|
    |    clean| 7648|
    |     nice| 7415|
    |      did| 7204|
    |breakfast| 7111|
    |       no| 6809|
    |    night| 6328|
    |  service| 6228|
    |     time| 6151|
    +---------+-----+
</details>

##### Calculate IDF #####
    val calcIdfIDF = udf { (df: Long, cnt: Long) => math.log((cnt + 1).toFloat / (df + 1).toFloat) }
    val idf = df.withColumn("idf", calcIdfIDF(col("df"), lit(hotels_review.count)))

<details>
    <summary>Output</summary>
    +---------+-----+-------------------+
    |    token|   df|                idf|
    +---------+-----+-------------------+
    |    hotel|16319|0.22764324297506697|
    |     room|14049|0.37741220731886344|
    |      not|12123| 0.5248476239146217|
    |    staff|11522| 0.5756895184231691|
    |    great|11020| 0.6202320109713476|
    |     stay|10094| 0.7079943191056576|
    |     good| 9277| 0.7923885365012432|
    |   stayed| 8549| 0.8741032962987842|
    |       nt| 8379| 0.8941866740612332|
    |    rooms| 8336| 0.8993311110230572|
    | location| 8164| 0.9201778776651405|
    |     just| 7736| 0.9740205247620138|
    |    clean| 7648| 0.9854596615720738|
    |     nice| 7415| 1.0163947078423756|
    |      did| 7204| 1.0452593306568616|
    |breakfast| 7111|  1.058251087504751|
    |       no| 6809| 1.1016424437282084|
    |    night| 6328| 1.1748923570262166|
    |  service| 6228| 1.1908187790138616|
    |     time| 6151| 1.2032573403890534|
    +---------+-----+-------------------+
</details>


##### Calculate TF-IDF #####
Round 4
    
    val tfidf = tf
      .join(idf, Seq("token"), "right")
      .withColumn("tf_idf", round(col("tf") * col("idf"), 4))

<details>
    <summary>Output</summary>
      +-----+-----------+---+-----+-------------------+------+
    |token|     doc_id| tf|   df|                idf|tf_idf|
    +-----+-----------+---+-----+-------------------+------+
    |hotel|25769804372|  3|16319|0.22764324297506697|0.6829|
    |hotel|25769804331|  3|16319|0.22764324297506697|0.6829|
    |hotel|25769803965|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179874702|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179874388|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179874316|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179873502|  1|16319|0.22764324297506697|0.2276|
    |hotel|17179873434|  1|16319|0.22764324297506697|0.2276|
    |hotel|17179873246|  3|16319|0.22764324297506697|0.6829|
    |hotel|17179873193|  1|16319|0.22764324297506697|0.2276|
    |hotel|17179873150|  3|16319|0.22764324297506697|0.6829|
    |hotel|17179873072|  4|16319|0.22764324297506697|0.9106|
    |hotel|17179873031|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179871970|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179871382|  2|16319|0.22764324297506697|0.4553|
    |hotel|17179871044|  3|16319|0.22764324297506697|0.6829|
    |hotel|17179870930|  3|16319|0.22764324297506697|0.6829|
    |hotel|17179870811|  1|16319|0.22764324297506697|0.2276|
    |hotel|17179870370|  3|16319|0.22764324297506697|0.6829|
    |hotel|17179870205|  4|16319|0.22764324297506697|0.9106|
    +-----+-----------+---+-----+-------------------+------+

</details>


##### Pivot Table #####
    val tfidf_pivot = tfidf.groupBy("token").pivot("tf").max("tf_idf").na.fill(0)

<details>
    <summary>Output</summary>
    +---------+------+------+------+------+------+------+------+------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+------+-------+-------+-------+-------+-------+---+------+------+-------+-------+
    |    token|     1|     2|     3|     4|     5|     6|     7|     8|      9|     10|     11|     12|     13|     14|     15|     16|     17|     18|     19|     20|     21|     22|     23|     24|    25|     26|     27|     29|     30|     31| 32|    33|    34|     36|     52|
    +---------+------+------+------+------+------+------+------+------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+------+-------+-------+-------+-------+-------+---+------+------+-------+-------+
    |    hotel|0.2276|0.4553|0.6829|0.9106|1.1382|1.3659|1.5935|1.8211| 2.0488| 2.2764| 2.5041| 2.7317| 2.9594|  3.187| 3.4146| 3.6423| 3.8699| 4.0976| 4.3252| 4.5529| 4.7805| 5.0082|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|7.5122|7.7399|    0.0|    0.0|
    |     room|0.3774|0.7548|1.1322|1.5096|1.8871|2.2645|2.6419|3.0193| 3.3967| 3.7741| 4.1515| 4.5289| 4.9064| 5.2838| 5.6612| 6.0386|  6.416|    0.0|    0.0| 7.5482|    0.0|    0.0| 8.6805|    0.0|9.4353| 9.8127|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |      not|0.5248|1.0497|1.5745|2.0994|2.6242|3.1491|3.6739|4.1988| 4.7236| 5.2485| 5.7733| 6.2982|  6.823| 7.3479| 7.8727| 8.3976| 8.9224| 9.4473| 9.9721| 10.497|11.0218|11.5466|12.0715|12.5963|   0.0|    0.0|14.1709|15.2206|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |    staff|0.5757|1.1514|1.7271|2.3028|2.8784|3.4541|4.0298|4.6055| 5.1812| 5.7569|    0.0| 6.9083|    0.0|    0.0|    0.0|  9.211|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |    great|0.6202|1.2405|1.8607|2.4809|3.1012|3.7214|4.3416|4.9619| 5.5821| 6.2023| 6.8226| 7.4428|  8.063| 8.6832|    0.0|    0.0|10.5439|    0.0|    0.0|    0.0|13.0249|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |     stay| 0.708| 1.416| 2.124| 2.832|  3.54| 4.248| 4.956| 5.664|    0.0|    0.0| 7.7879|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |     good|0.7924|1.5848|2.3772|3.1696|3.9619|4.7543|5.5467|6.3391| 7.1315| 7.9239| 8.7163| 9.5087|10.3011|11.0934|11.8858|    0.0|13.4706|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |   stayed|0.8741|1.7482|2.6223|3.4964|4.3705|   0.0|   0.0|   0.0|    0.0|  8.741|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |       nt|0.8942|1.7884|2.6826|3.5767|4.4709|5.3651|6.2593|7.1535| 8.0477| 8.9419| 9.8361|10.7302|11.6244|12.5186|13.4128| 14.307|15.2012|16.0954|16.9895|17.8837|18.7779|19.6721|20.5663|    0.0|   0.0|23.2489| 24.143|25.9314|26.8256|27.7198|0.0|   0.0|   0.0|    0.0|46.4977|
    |    rooms|0.8993|1.7987| 2.698|3.5973|4.4967| 5.396|6.2953|7.1946|  8.094| 8.9933| 9.8926| 10.792|    0.0|    0.0|    0.0|    0.0|    0.0| 16.188|    0.0|    0.0|    0.0|19.7853|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    | location|0.9202|1.8404|2.7605|3.6807|4.6009|5.5211|6.4412|7.3614|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |     just| 0.974| 1.948|2.9221|3.8961|4.8701|5.8441|6.8181|7.7922| 8.7662| 9.7402|10.7142|11.6882|12.6623|13.6363|14.6103|15.5843|16.5583|    0.0|    0.0|    0.0|20.4544|    0.0|    0.0|    0.0|   0.0|    0.0|26.2986|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |    clean|0.9855|1.9709|2.9564|3.9418|4.9273|5.9128|   0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |     nice|1.0164|2.0328|3.0492|4.0656| 5.082|6.0984|7.1148|8.1312| 9.1476|10.1639|11.1803|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |      did|1.0453|2.0905|3.1358| 4.181|5.2263|6.2716|7.3168|8.3621| 9.4073|10.4526|11.4979|12.5431|13.5884|14.6336|15.6789|16.7241|    0.0|18.8147|    0.0|20.9052|    0.0|    0.0|    0.0|    0.0|   0.0|27.1767| 28.222|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|37.6293|    0.0|
    |breakfast|1.0583|2.1165|3.1748| 4.233|5.2913|6.3495|7.4078| 8.466| 9.5243|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |       no|1.1016|2.2033|3.3049|4.4066|5.5082|6.6099|7.7115|8.8131| 9.9148|11.0164|12.1181|13.2197|14.3214| 15.423|16.5246|17.6263|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |    night|1.1749|2.3498|3.5247|4.6996|5.8745|7.0494|8.2242|9.3991| 10.574|11.7489|12.9238|14.0987|15.2736|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |  service|1.1908|2.3816|3.5725|4.7633|5.9541|7.1449|8.3357|9.5266|10.7174|11.9082| 13.099|14.2898|    0.0|    0.0|17.8623|19.0531|    0.0|21.4347|    0.0|23.8164|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    |     time|1.2033|2.4065|3.6098| 4.813|6.0163|7.2195|8.4228|9.6261|10.8293|12.0326|13.2358|    0.0|15.6423|16.8456|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|    0.0|   0.0|    0.0|    0.0|    0.0|    0.0|    0.0|0.0|   0.0|   0.0|    0.0|    0.0|
    +---------+------+------+------+------+------+------+------+------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+-------+------+-------+-------+-------+-------+-------+---+------+------+-------+-------+    
</details>
